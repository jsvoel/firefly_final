/* 
 * File:   main.cpp
 * Author: johannes
 *
 * Created on 27. April 2015, 12:26
 */

#include <time.h>
#include <math.h>

#include <ncurses.h>

#include "Firefly.h"
#include "SensorCommand.h"
#include "NavigationCommand.h"

/*
 * 
 */
void sensors() {
    GPSDataCommand gps;
    IMUDataCommand imu;
    LLStatusCommand lls;
    timespec reqt, remt;

    reqt.tv_sec = 1;
    reqt.tv_nsec = 0;

    while (true) {
        try {
            gps.execute();
            if (gps.getData()->status == 0x03) {
                std::cout << "Latitude: " << gps.getData()->latitude << std::endl;
                std::cout << "Longtiude: " << gps.getData()->longitude << std::endl;
            }
            imu.execute();
            std::cout << "Nick: " << imu.getData()->angle_nick << std::endl;
            std::cout << "Roll: " << imu.getData()->angle_roll << std::endl;
            std::cout << "Yaw : " << imu.getData()->angle_yaw << std::endl;
            lls.execute();
            std::cout << "Battery: " << lls.getData()->battery_voltage_1 << std::endl;
            std::cout << "--------------------------------------------------------" << std::endl;
        } catch (std::runtime_error &e) {
            std::cout << "Runtime error: " << e.what() << std::endl;
        }
        nanosleep(&reqt, &remt);
    }
}

void waypoints() {
    LaunchCommand ln;
    WaypointCommand wp;
    EndCommand ed;
    timespec reqt, remt;

    reqt.tv_sec = 10;
    reqt.tv_nsec = 0;
    try {
        std::cout << "Launch.." << std::endl;
        ln.execute();

        reqt.tv_sec = 5;
        nanosleep(&reqt, &remt);
        std::cout << "2 Meter.." << std::endl;
        wp.setRelative(0, 0, 2);
        wp.execute();

        nanosleep(&reqt, &remt);
        std::cout << "Land.." << std::endl;
        ed.execute();
    } catch (std::runtime_error &e) {
        std::cout << "Runtime error: " << e.what() << std::endl;
    }
}

int kbhit(void) {
    int ch = getch();

    if (ch != ERR) {
        ungetch(ch);
        return 1;
    } else {
        return 0;
    }
}

void generatewaypoint() {
    WaypointCommand wpc;
    int x, y, h;
    char c;
    std::cout << "Set Relative Waypoint: X, Y, Height:";
    std::cin >> x >> y >> h;
    std::cout << "\n\rExecute Waypoint with:\n\rX: " << x << "\n\rY: " << y << "\n\rH: " << h << "\n\rYes (y) or anything else\n\r";
    std::cin >> c;
    if(c == 'y'){
        std::cout << "\n\rExecuting!\n\r";
        wpc.setRelative(x, y, h);
        wpc.execute();
    }else{
        std::cout << "\n\rAborting!\n\r";
    }
}

void interactive() {
    CurrentWayCommand cwc;
    LaunchCommand lnc;
    EndCommand edc;
    GotoCommand gtc;
    HomeCommand hec;
    GPSDataCommand gps;
    const char* statusstring;
    char input = '$';
    double sx, sy, st;
    
    timespec reqt, remt;

    reqt.tv_sec = 0;
    reqt.tv_nsec = 250 * 1000 * 1000;


    initscr();

    cbreak();
    noecho();
    nodelay(stdscr, TRUE);

    scrollok(stdscr, TRUE);

    while (true) {
        try {
            cwc.execute();
            gps.execute();
//            clear();
            if (gps.getData()->status == 0x03) {
                std::cout << "Latitude: " << gps.getData()->latitude << "Longtitude: " << gps.getData()->longitude << "\n\r";
                sx = gps.getData()->speed_x;
                sy = gps.getData()->speed_y;
                st = sqrt((sx*sx)+(sy*sy));
                st = st*0.0036;
                std::cout << "Speed: " << st <<" km/h\n\r";
            }
            switch (cwc.getData()->status) {
                case 0: statusstring = "Stand By\n\r";
                case 1: statusstring = "Execute from Flash\n\r";
                case 2: statusstring = "PC Controlled\n\r";
                default: statusstring = "undefined\n\r";
            }
            std::cout << "Navigation status:\t" << statusstring;
            std::cout << "Reached Waypoint:\t\t" << ((cwc.getData()->navigation_status & WP_NAVSTAT_REACHED_POS) ? "Yes\n\r" : "NO\n\r");
            std::cout << "Reached Time: \t\t\t" << ((cwc.getData()->navigation_status & WP_NAVSTAT_REACHED_POS_TIME) ? "Yes\n\r" : "NO\n\r");
            std::cout << "Within 20m of WP:\t\t" << ((cwc.getData()->navigation_status & WP_NAVSTAT_20M) ? "Yes\n\r" : "NO\n\r");
            std::cout << "Aborted by Pilot:\t\t" << ((cwc.getData()->navigation_status & WP_NAVSTAT_PILOT_ABORT) ? "Yes\n\r" : "NO\n\r");
            std::cout << "Number of Waypoints:\t\t" << cwc.getData()->nr_of_wp << "\n\r";
            std::cout << "Next Waypoint:\t\t\t" << cwc.getData()->current_wp << "\n\r";
            std::cout << "------------------------------------------------------\n\r";
            std::cout << "q - Abort Flight\n\rw - New Waypoint\n\re - Launch\n\rr - Goto Next\n\rt - Come Home\n\rInput: ";
	    reqt.tv_sec = 0;
            if (kbhit()) {
                reqt.tv_sec = 2;
                input = getch();
                std::cout << input << "\n\rExecuting ";
                switch (input) {
                    case 'q': std::cout << "End\n\r";
                        edc.execute();
                        break;
                    case 'w':std::cout << "Waypoint\n\r";
                        generatewaypoint();
                        break;
                    case 'e': std::cout << "Launch\n\r";
                        lnc.execute();
                        break;
                    case 'r': std::cout << "Goto\n\r";
                        gtc.execute();
                        break;
                    case 't':std::cout << "Home\n\r";
                        hec.execute();
                        break;
                    default: std::cout << "Unknown Command!\n\r";
                }
            }
            nanosleep(&reqt, &remt);
        } catch (std::runtime_error &e) {
            std::cout << "Runtime error: " << e.what() << std::endl;
        }
    }
}

int main(int argc, char** argv) {
    try {
        //sensors();
        //waypoints();
        interactive();
    } catch (std::runtime_error &e) {
        std::cout << "Runtime error: " << e.what() << std::endl;
    } catch (std::exception &e) {
        std::cout << "Exception: " << e.what() << std::endl;
    } catch (...) {
        std::cout << "Uncaught Exception" << std::endl;
    }

    return 0;
}
